<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .card { max-width: 900px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; }
    .muted { color: #6b7280; }
    input, button { padding: 8px 12px; border-radius: 8px; }
    button { border: 1px solid #3b82f6; background: #3b82f6; color: #fff; cursor: pointer; }
    .row { display: flex; gap: 8px; margin: 8px 0; }
    .danger { background: #ef4444; border-color: #ef4444; }
    .success { color: #16a34a; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Admin Dashboard</h2>
    <p class="muted">Only admins can access this page.</p>
    <p class="muted">Role: <span id="role">unknown</span></p>

    <div class="row">
      <input id="tUsername" placeholder="Teacher username" />
      <input id="tEmail" placeholder="Teacher email" />
      <input id="tPassword" type="password" placeholder="Temp password" />
      <button id="createTeacher">Create Teacher</button>
    </div>
    <p id="createTeacherStatus" class="muted"></p>
    <hr />

    <h3>Students</h3>
    <div class="row" style="align-items:flex-start;">
      <div style="flex:1; min-width:280px;">
        <table id="studentsTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Email</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Username</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Status</th>
            </tr>
          </thead>
          <tbody id="studentsBody">
            <tr><td class="muted" colspan="3">Loading students...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="flex:1; min-width:280px;">
        <h3>Selected Student Activity</h3>
        <pre id="activity">Select a student to view activity</pre>
      </div>
    </div>

    <button id="logout" class="danger">Logout</button>
  </div>
  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    document.getElementById('role').textContent = role || 'unknown';
    if (!token || role !== 'admin') { window.location.href = '/'; }

    async function loadStudents() {
      const tbody = document.getElementById('studentsBody');
      tbody.innerHTML = '<tr><td class="muted" colspan="3">Loading students...</td></tr>';
      try {
        const res = await fetch('/admin/users/students', { headers: { Authorization: `Bearer ${token}` } });
        const list = await res.json();
        if (!res.ok) throw new Error(list.error || 'Failed to load students');
        if (!Array.isArray(list) || list.length === 0) {
          tbody.innerHTML = '<tr><td class="muted" colspan="3">No students found.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        list.forEach(stu => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px; border-bottom:1px solid #f1f5f9;">${stu.email}</td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9;">${stu.username}</td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9;" class="muted">${stu.status || 'active'}</td>
          `;
          tr.style.cursor = 'pointer';
          tr.addEventListener('click', () => loadActivityFor(stu._id, stu.email));
          tbody.appendChild(tr);
        });
      } catch (e) {
        tbody.innerHTML = `<tr><td class="muted" colspan="3">${e.message}</td></tr>`;
      }
    }

    async function loadActivityFor(userId, label) {
      const pre = document.getElementById('activity');
      pre.textContent = `Loading activity for ${label}...`;
      try {
        const res = await fetch(`/admin/activity?limit=50&userId=${encodeURIComponent(userId)}`, { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load activity');
        pre.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        pre.textContent = e.message;
      }
    }
    loadStudents();

    document.getElementById('createTeacher').addEventListener('click', async () => {
      const username = document.getElementById('tUsername').value.trim();
      const email = document.getElementById('tEmail').value.trim();
      const password = document.getElementById('tPassword').value;
      const statusEl = document.getElementById('createTeacherStatus');
      statusEl.textContent = '';
      try {
        const res = await fetch('/admin/users/teacher', {
          method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ username, email, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        statusEl.textContent = `Created teacher: ${data.username}`;
        statusEl.className = 'success';
      } catch (e) {
        statusEl.textContent = e.message;
        statusEl.className = 'muted';
      }
    });

    document.getElementById('logout').addEventListener('click', async () => {
      if (token) await fetch('/auth/logout', { method: 'POST', headers: { Authorization: `Bearer ${token}` } });
      localStorage.clear();
      window.location.href = '/';
    });
  </script>
</body>
</html>